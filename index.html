<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Pocket Abyss - Campaign Edition</title> 
    
    <meta property="og:title" content="Pocket Abyss"> 
    <meta property="og:description" content="Can you survive the abyss? Play my retro pixel survival game now!"> 
    <meta property="og:image" content="thumbnail.png">  
    <meta name="twitter:card" content="summary_large_image"> 

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap'); 

        :root { 
            --gb-body: #c0c0c0; 
            --gb-screen-lens: #555; 
            --screen-bg: #0f380f; 
            --accent: #b45252; 
        } 

        /* PREVENT FLASHING ON LOAD */
        body.preload * {
            transition: none !important;
        }

        body { 
            margin: 0; padding: 0; 
            background-color: #111; color: white; 
            font-family: 'Press Start 2P', cursive; 
            display: flex; flex-direction: column; /* FIXED: Prevents overlap */
            align-items: center; justify-content: center; 
            height: 100vh; overflow: hidden; 
            touch-action: none; user-select: none; 
            -webkit-tap-highlight-color: transparent;
        } 

        /* --- CONSOLE SHELL --- */ 
        #gb-shell { 
            background-color: var(--gb-body); 
            width: 420px; height: 800px; 
            border-radius: 15px 15px 50px 15px; 
            box-shadow: -5px 5px 25px rgba(0,0,0,0.6), inset 2px 2px 8px rgba(255,255,255,0.4); 
            display: flex; flex-direction: column; align-items: center; 
            padding-top: 40px; position: relative; 
            transform: scale(0.9); 
        } 
        @media (max-height: 850px) { #gb-shell { transform: scale(0.70); } } 

        #gb-screen-lens { 
            background-color: var(--gb-screen-lens); 
            width: 380px; padding: 25px 0; 
            border-radius: 10px 10px 40px 10px; 
            display: flex; flex-direction: column; align-items: center; 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); 
        } 

        .lens-text { 
            color: #b0b0b0; font-size: 12px; width: 90%; 
            display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; 
        } 
        
        .power-light { 
            width: 12px; height: 12px; border-radius: 50%; 
            background: radial-gradient(circle at 30% 30%, #555, #222); 
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.1); 
            border: 1px solid #111; transition: all 0.3s; 
        } 
        .power-light.on { 
            background: radial-gradient(circle at 30% 30%, #ffaaaa, #ff0000); 
            box-shadow: 0 0 4px #ff0000, 0 0 10px #ff3333, inset 1px 1px 1px rgba(255,255,255,0.5); 
            border-color: #aa0000; 
        } 

        /* --- SCREEN --- */ 
        #screen-wrapper { 
            position: relative; width: 320px; height: 320px; 
            background-color: #000; border: 3px solid #444; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8); overflow: hidden; 
        } 

        canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; } 

        /* UI Overlays */ 
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; flex-direction: column; z-index: 5; 
        } 

        #hud { 
            padding: 10px; display: none; /* Hidden initially to prevent glitch */
            justify-content: space-between; 
            font-size: 10px; text-shadow: 2px 2px 0 #000; color: #fff; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); 
        } 
        #lives-display { color: var(--accent); } 

        #dash-bar-container { 
            position: absolute; bottom: 10px; left: 10px; 
            width: 60px; height: 6px; background: #333; border: 1px solid #fff; 
            display: none; /* Hidden initially */
        } 
        #dash-bar { width: 100%; height: 100%; background: #00ff00; transform-origin: left; } 

        /* --- MODALS --- */ 
        .modal-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); display: none; flex-direction: column; 
            align-items: center; justify-content: center; pointer-events: auto; 
            z-index: 10; text-align: center; 
        } 

        /* Settings Icon */ 
        #settings-btn { 
            position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; 
            background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 16px; cursor: pointer; pointer-events: auto; z-index: 20; 
        } 
        
        /* TEXT & BUTTONS */ 
        h1 {  
            color: #d3a068; font-size: 22px; margin-bottom: 10px;  
            text-shadow: 4px 4px 0 #4e3328; line-height: 1.5;  
        } 
        h2 { 
            font-size: 12px; color: #d3a068; margin-bottom: 8px; margin-top: 5px; 
        } 
        
        button, .lb-btn { 
            background: var(--accent); color: white; border: 3px solid #fff; 
            padding: 10px 15px; font-family: 'Press Start 2P', cursive; 
            font-size: 10px; cursor: pointer; text-transform: uppercase; 
            box-shadow: 0 4px 0 #521b1b; margin: 5px; pointer-events: auto; 
            display: flex; justify-content: center; align-items: center; text-align: center; 
        } 
        button:hover { background: #d3a068; transform: translateY(2px); box-shadow: 0 2px 0 #521b1b; } 
        button:active { transform: translateY(4px); box-shadow: none; } 

        /* Toggles & Settings */ 
        .settings-box { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; margin-top: 5px; } 
        .setting-row { display: flex; justify-content: space-between; align-items: center; font-size: 10px; width: 140px; } 
        
        /* Horizontal Audio Row */ 
        .audio-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; } 
        .audio-item { display: flex; flex-direction: row; align-items: center; gap: 8px; font-size: 10px; } 

        .toggle-btn { background: #333; border: 2px solid #fff; color: #fff; padding: 5px; cursor: pointer; font-size: 8px; width: 50px; } 
        .toggle-btn.active { background: #4b692f; } 

        /* --- BUTTON LAYOUTS --- */
        .btn-row { display: flex; gap: 8px; margin-top: 4px; justify-content: center; } 

        /* COMPACT Game Over Styles */
        .game-over-mode h1 { margin-top: 15px; margin-bottom: 5px; font-size: 20px; }
        .game-over-mode .btn-row { gap: 4px; margin-top: 2px; }
        .game-over-mode button { margin: 2px; padding: 8px 10px; font-size: 9px; }
        .game-over-mode #start-btn { background: #d3a068; color: #000; font-weight: bold; width: 100px; }

        /* Pause Menu Compactness */
        #pause-menu { gap: 2px; }  
        #pause-menu h1 { margin-top: 25px; margin-bottom: 5px; } 
        #pause-level-txt { margin-bottom: 8px; font-size: 8px; } 
        #pause-menu button { margin: 3px; } 
        #pause-menu .settings-box { margin-top: 5px; gap: 4px; } 

        /* Start / Game Over Screen */ 
        #end-game-info { margin-bottom: 5px; } 
        #end-game-info p { margin-bottom: 4px; } 

        /* Animations */ 
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } } 
        @keyframes slideDown { 0% { transform: translateY(-30px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } } 
        @keyframes scorePulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); text-shadow: 0 0 15px #ffff00; color: #ffff00; } 100% { transform: scale(1); } } 
        @keyframes fadePop { 0% { opacity:1; transform:scale(1); } 100% { opacity:0; transform:scale(2.5); } } 
        
        .anim-bounce { animation: bounce 1.5s infinite ease-in-out; } 
        .anim-slide { animation: slideDown 0.5s ease-out; } 
        .score-pop { animation: scorePulse 1s infinite; } 
        
        /* Countdown Overlay */ 
        #countdown-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; align-items: center; justify-content: center; 
            pointer-events: none; z-index: 50; 
        } 
        .countdown-num { 
            font-size: 80px; color: #ffff00; text-shadow: 4px 4px 0 #b45252; 
            animation: fadePop 0.9s ease-out forwards; 
        } 

        /* --- CONTROLS --- */ 
        #controls-area { width: 100%; height: 320px; position: relative; margin-top: 20px; } 

        .d-pad { position: absolute; top: 40px; left: 30px; width: 180px; height: 180px; } 
        .d-pad-bg { position: absolute; background: #333; border-radius: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); } 
        .d-v { width: 60px; height: 180px; top: 0; left: 60px; }  
        .d-h { width: 180px; height: 60px; top: 60px; left: 0; } 
        
        .d-btn { 
            position: absolute; z-index: 10; 
            background: rgba(255, 255, 255, 0.3); 
            opacity: 0; /* Hidden by default */
            border-radius: 4px; pointer-events: none; 
            /* FIXED: Removed default transition to prevent 'fade out' glitch on load */
        } 
        .d-btn.active { 
            opacity: 1; 
            transition: opacity 0.1s; /* Only animate when pressing */
        } 
        .up { width: 60px; height: 60px; top: 0; left: 60px; } 
        .down { width: 60px; height: 60px; bottom: 0; left: 60px; } 
        .left { width: 60px; height: 60px; top: 60px; left: 0; } 
        .right { width: 60px; height: 60px; top: 60px; right: 0; } 

        .action-btn-group { position: absolute; top: 80px; right: 20px; width: 170px; height: 90px; transform: rotate(-15deg); } 
        .ab-btn { 
            width: 75px; height: 75px; border-radius: 50%; background: var(--accent); 
            box-shadow: 2px 4px 0 rgba(0,0,0,0.4), inset -2px -4px 5px rgba(0,0,0,0.2); 
            position: absolute; display: flex; align-items: center; justify-content: center; 
            font-size: 24px; color: #521b1b; font-weight: bold; border: 1px solid rgba(0,0,0,0.1); 
            transition: transform 0.1s; 
        } 
        .ab-btn.active { transform: scale(0.95) translateY(2px); box-shadow: 1px 1px 0 rgba(0,0,0,0.4); background-color: #c26161; } 
        .btn-b { bottom: -10px; left: 0; } 
        .btn-a { top: -10px; right: 0; } 

        /* UI Helpers */ 
        #leaderboard-screen { padding-top: 20px; justify-content: start; z-index: 15; } 
        .lb-row { display: flex; justify-content: space-between; width: 80%; margin-bottom: 8px; border-bottom: 1px dashed #333; font-size: 10px; padding-bottom: 2px; } 
        
        .input-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; justify-content: center; } 
        #player-name-input {  
            background: #000; border: 2px solid #00ff00; color: #00ff00;  
            font-family: inherit; padding: 10px; text-transform: uppercase;  
            text-align: center; font-size: 10px; width: 120px; 
        } 
        .message-overlay { position: absolute; top: 45%; width: 100%; text-align: center; font-size: 20px; color: #fff; text-shadow: 3px 3px 0 #000; display: none; z-index: 8; } 
        .help-text { font-size: 9px; color: #ccc; line-height: 1.8; text-align: left; width: 80%; margin-bottom: 5px; } 
    </style> 
</head> 
<body class="preload"> 

    <div id="gb-shell"> 
        <div id="gb-screen-lens"> 
            <div class="lens-text"> 
                <span>BATTERY</span> 
                <div class="power-light" id="power-led"></div> 
            </div> 
            
            <div id="screen-wrapper"> 
                <canvas id="gameCanvas" width="320" height="320"></canvas> 
                
                <div id="countdown-overlay"></div> 

                <div id="ui-layer"> 
                    <div id="settings-btn">⚙️</div> 

                    <div id="pause-menu" class="modal-screen"> 
                        <h1 style="color: #ffff00;">PAUSED</h1> 
                        <p id="pause-level-txt" style="color: #d3a068;">LEVEL 1</p> 
                        
                        <button id="resume-btn" style="width: 80px;">RESUME</button> 
                        <button id="pause-home-btn" style="width: 80px; background: #555;">HOME</button> 
                        <button id="pause-help-btn" style="width: 80px; font-size: 8px;">CONTROLS</button> 
                        
                        <div class="settings-box"> 
                            <div class="setting-row"><span>MUSIC</span> <button class="toggle-music toggle-btn active">ON</button></div> 
                            <div class="setting-row"><span>SFX</span> <button class="toggle-sfx toggle-btn active">ON</button></div> 
                        </div> 
                    </div> 

                    <div id="help-screen" class="modal-screen"> 
                        <h1 style="margin-bottom: 5px;">CONTROLS</h1> 
                        
                        <div class="help-text"> 
                            <span style="color:#d3a068">KEYBOARD:</span><br> 
                            ARROWS: Move<br>Z or SPACE: Dash<br>P KEY: Pause 
                            <br><br> 
                            <span style="color:#d3a068">MOBILE:</span><br> 
                            D-PAD: Slide to Move<br>BTN A: Dash<br>GEAR ICON: Pause 
                        </div> 

                        <div style="width: 80%; border-bottom: 1px dashed #444; margin-bottom: 10px;"></div> 

                        <h2>AUDIO SETTINGS</h2> 
                        <div class="audio-row"> 
                            <div class="audio-item"> 
                                <span>MUSIC</span> 
                                <button class="toggle-music toggle-btn active">ON</button> 
                            </div> 
                            <div class="audio-item"> 
                                <span>SFX</span> 
                                <button class="toggle-sfx toggle-btn active">ON</button> 
                            </div> 
                        </div> 

                        <button id="close-help-btn" style="margin-top: 10px;">BACK</button> 
                    </div> 

                    <div id="hud"> 
                        <span id="score-display">SCORE: 0</span> 
                        <span id="lives-display">♥♥</span> 
                        <span id="level-display">LVL: 1</span> 
                        <span id="timer-display"></span> 
                    </div> 
                    <div id="dash-bar-container"><div id="dash-bar"></div></div> 
                </div> 

                <div id="leaderboard-screen" class="modal-screen"> 
                    <h1 style="font-size: 18px; margin-bottom: 15px; color:#d3a068;">TOP 10</h1> 
                    <div id="scores-list" style="width: 100%; display: flex; flex-direction: column; align-items: center; flex-grow: 1;"> 
                        <div style="color: #555; font-size: 10px;">LOADING...</div> 
                    </div> 
                    <button class="lb-btn" id="close-lb-btn" style="margin-bottom: 20px;">CLOSE</button> 
                </div> 

                <div id="level10-screen" class="modal-screen"> 
                    <h1 style="font-size: 16px; color: #00ff00;">THANK YOU!</h1> 
                    <p style="font-size: 10px; line-height: 1.6; color: #ddd; margin-bottom: 20px;"> 
                        To my friend:<br>Thank you for your support.<br>I hope you love this game! 
                    </p> 
                    <p style="color:#d3a068; font-size: 10px; margin-bottom: 10px;">Would you like to continue?</p> 
                    <div style="display: flex; gap: 15px;"> 
                        <button id="l10-yes-btn">YES</button> 
                        <button id="l10-no-btn" style="background:#555;">NO</button> 
                    </div> 
                </div> 

                <div id="start-screen" class="modal-screen" style="display: flex;"> 
                    <h1 id="game-title" class="anim-bounce">POCKET<br>ABYSS</h1> 
                    
                    <div id="end-game-info" class="anim-slide" style="display:none; text-align: center;"> 
                        <p id="level-msg" style="color: #ffff00; font-size: 12px; margin-bottom: 5px;">STAGE CLEAR!</p> 
                        <p id="final-score" style="color: #b45252; font-size: 12px; margin-bottom: 10px;">SCORE: 0</p> 
                        
                        <div id="name-input-container" class="input-row" style="display: none;"> 
                            <input type="text" id="player-name-input" maxlength="6" placeholder="NAME"> 
                            <button id="submit-score-btn" style="width: 80px;">SUBMIT</button> 
                        </div> 
                    </div> 

                    <div class="btn-row"> 
                        <button id="start-btn" style="width: 100px;">START</button> 
                        <button id="home-btn" style="width: 100px; display: none; background: #555;">HOME</button> 
                    </div> 

                    <div class="btn-row"> 
                        <button id="view-lb-btn" style="width: 100px; font-size: 10px;">SCORES</button> 
                        <button id="start-help-btn" style="width: 35px; background: #555;">?</button> 
                    </div> 
                </div> 
                
                <div id="msg-overlay" class="message-overlay">LEVEL 1</div> 
            </div> 
            
            <div class="lens-text" style="justify-content: center; margin-top: 10px;"> 
                <span>DOT MATRIX WITH STEREO SOUND</span> 
            </div> 
        </div> 

        <div id="controls-area"> 
            <div class="d-pad"> 
                <div class="d-pad-bg d-v"></div> 
                <div class="d-pad-bg d-h"></div> 
                <div class="d-btn up" id="btn-up"></div> 
                <div class="d-btn down" id="btn-down"></div> 
                <div class="d-btn left" id="btn-left"></div> 
                <div class="d-btn right" id="btn-right"></div> 
            </div> 
            <div class="action-btn-group"> 
                <div class="ab-btn btn-b" id="btn-b">B</div> 
                <div class="ab-btn btn-a" id="btn-a">A</div> 
            </div> 
        </div> 

    </div> <script> 
/** * POCKET ABYSS: Campaign Edition 
 */ 

// ========================================== 
// 1. CONFIGURATION & ASSETS 
// ========================================== 
const firebaseConfig = { 
    apiKey: "AIzaSyASHsvjA_tV57Nc3j3YkQmwvMzCFh3iekA", 
    authDomain: "pixel-cavern.firebaseapp.com", 
    projectId: "pixel-cavern", 
    storageBucket: "pixel-cavern.firebasestorage.app", 
    messagingSenderId: "878527454928", 
    appId: "1:878527454928:web:042a8d2776ca158a0b48d5" 
}; 

const CANVAS_SIZE = 320;  
const DASH_DURATION = 15;  
const DASH_COOLDOWN = 60;  
const INVULNERABLE_DURATION = 300;  

// UPDATED PALETTE FOR BETTER CONTRAST
const PALETTE = { 
    hero: '#4b692f', // Muted Green
    
    // Updated Enemies: Using lighter, slightly desaturated reds/purples
    // to contrast against black background but NOT clash with green hero or gold coins
    slime: '#cd6060',  // Distinct Clay/Salmon Red (was muddy brown)
    snake: '#a64242',  // Darker Red (was very dark)
    bouncer: '#9b5c88', // Muted Purple/Magenta (completely different from red/green)
    
    // Level 10 Exclusive Colors
    cellSmall: '#00ff00', // Bright Bio Green
    cellGiant: '#2b592b', // Dark Mass

    coinMain: '#d3a068', 
    coinShine: '#ffe0a0', 
    dashTrail: 'rgba(75, 105, 47, 0.3)', 
    health: '#ffffff', 
    healthCross: '#ff0000', 
    blackBox: '#000000' 
}; 

const SPRITES = { 
    hero: [[0,0,1,1,1,1,0,0], [0,1,1,1,1,1,1,0], [0,1,0,1,1,0,1,0], [0,1,1,1,1,1,1,0], [0,0,1,1,1,1,0,0], [0,1,0,0,0,0,1,0], [1,0,1,0,0,1,0,1], [1,1,0,0,0,0,1,1]], 
    slime: [[0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0], [0,0,1,1,1,1,0,0], [0,1,1,1,1,1,1,0], [1,1,0,1,1,0,1,1], [1,1,1,1,1,1,1,1], [1,0,1,1,1,1,0,1], [0,1,0,0,0,0,1,0]], 
    snakeHead: [[0,0,1,1,1,1,0,0], [0,1,1,1,1,1,1,0], [1,1,0,1,1,0,1,1], [1,1,1,1,1,1,1,1], [1,1,1,1,1,1,1,1], [0,1,1,1,1,1,1,0], [0,0,1,0,0,1,0,0], [0,0,1,0,0,1,0,0]], 
    coin: [[0,0,1,1,1,0,0,0], [0,1,1,2,1,1,0,0], [1,1,2,2,2,1,1,0], [1,1,2,2,2,1,1,0], [1,1,2,2,2,1,1,0], [0,1,1,2,1,1,0,0], [0,0,1,1,1,0,0,0], [0,0,0,0,0,0,0,0]], 
    healthBag: [[2,2,2,2,2,2,2,2], [2,2,2,1,1,2,2,2], [2,2,2,1,1,2,2,2], [2,1,1,1,1,1,1,2], [2,1,1,1,1,1,1,2], [2,2,2,1,1,2,2,2], [2,2,2,1,1,2,2,2], [2,2,2,2,2,2,2,2]], 
    blackBox: [[1,1,1,1,1,1,1,1], [1,0,0,0,0,0,0,1], [1,0,0,0,0,0,0,1], [1,0,0,0,0,0,0,1], [1,0,0,0,0,0,0,1], [1,0,0,0,0,0,0,1], [1,0,0,0,0,0,0,1], [1,1,1,1,1,1,1,1]] 
}; 

// UPDATED LEVEL BALANCE (L7-L9 TUNED DOWN, L10 PETRI)
const LEVELS = [ 
    { id: 1, targetScore: 100, type: 'chaser', spawnRate: 200, spawnCount: 2, speedLevel: 1, bg: ['#1a1016', '#20141c'], msg: "THE SWARM BEGINS", music: 'swarm' }, 
    { id: 2, targetScore: 300, type: 'chaser', spawnRate: 170, spawnCount: 2, speedLevel: 2, bg: ['#1a1016', '#20141c'], msg: "FASTER...", music: 'danger' }, 
    { id: 3, targetScore: 500, type: 'chaser', spawnRate: 140, spawnCount: 2, speedLevel: 3, bg: ['#1a1016', '#20141c'], msg: "SURVIVE!", music: 'marching' }, 
    { id: 4, targetScore: 1000, timeLimit: 300, type: 'snake', snakeLen: 5, speedLevel: 4, bg: ['#2b0d0d', '#3d1212'], msg: "IT COMBINED!", music: 'venom_p1' }, 
    { id: 5, targetScore: 1000, timeLimit: 300, type: 'snake', snakeLen: 8, speedLevel: 5, bg: ['#2b0d0d', '#3d1212'], msg: "IT GROWS...", music: 'venom_p2' }, 
    { id: 6, targetScore: 1000, timeLimit: 300, type: 'snake', snakeLen: 12, speedLevel: 6, bg: ['#2b0d0d', '#3d1212'], msg: "GIANT SERPENT", music: 'venom_full' },  
    { id: 7, targetScore: 1500, type: 'bouncer', spawnRate: 200, spawnCount: 1, speedLevel: 6, bg: ['#0d2b2b', '#123838'], msg: "IT SHATTERED!", music: 'chaos_p1' }, 
    { id: 8, targetScore: 1500, type: 'bouncer', spawnRate: 180, spawnCount: 1, speedLevel: 7, bg: ['#0d2b2b', '#123838'], msg: "BOUNCING CHAOS", music: 'chaos_p2' }, 
    { id: 9, targetScore: 1500, type: 'bouncer', spawnRate: 160, spawnCount: 1, speedLevel: 8, bg: ['#0d2b2b', '#123838'], msg: "DONT TOUCH", music: 'chaos_full' }, 
    // LEVEL 10: "THE PETRI DISH" (Reinforcement Logic, Cap 30)
    { id: 10, targetScore: 999999, type: 'petri', spawnRate: 9999, maxEnemies: 30, speedLevel: 10, bg: ['#000', '#111'], msg: "LEVEL 10: THE OUTBREAK", music: 'hero_extended' } 
]; 

const SONGS = { 
    victory: { tempo: 140, lead: ['C5','E5','G5','C6', 'E6','G6','C7','XX', 'C7','XX','XX','XX', 'XX','XX','XX','XX'], bass: ['C3','C3','E3','E3', 'G3','G3','C4','XX', 'C4','XX','XX','XX', 'XX','XX','XX','XX'] }, 
    gameover: { tempo: 150, lead: ['C5','B4','Bb4','A4', 'Ab4','G4','Gb4','F4', 'E4','Eb4','D4','Db4', 'C4','XX','XX','XX'], bass: ['F#4','F4','E4','Eb4', 'D4','Db4','C4','B3', 'Bb3','A3','Ab3','G3', 'C3','XX','XX','XX'] }, 
    intro: { tempo: 280, lead: ['A4','XX','C5','XX','E5','XX','C5','XX','B4','XX','D5','XX','F5','XX','E5','XX','A5','XX','G5','XX','E5','XX','C5','XX','E5','XX','G5','XX','XX','XX','XX','XX','C5','XX','D5','XX','E5','XX','G5','XX','A5','XX','XX','XX','F5','XX','XX','XX','E5','XX','G5','XX','A5','XX','C6','XX','B5','XX','A5','XX','XX','XX','XX','XX'], bass: ['A2','XX','XX','XX','E2','XX','XX','XX','B2','XX','XX','XX','D3','XX','XX','XX','A2','XX','XX','XX','G2','XX','XX','XX','E2','XX','XX','XX','XX','XX','XX','XX'] }, 
    swarm: { tempo: 290, lead: ['E5','XX','G5','XX','A5','XX','G5','XX','F5','XX','E5','XX','D5','XX','C5','XX','G5','XX','A5','XX','C6','XX','A5','XX','E5','XX','XX','XX','XX','XX','XX','XX'], bass: ['C3','XX','E3','XX','G3','XX','A3','XX','F3','XX','A3','XX','F3','XX','D3','XX','G3','XX','B2','XX','C3','XX','D3','XX','E3','XX','XX','XX','XX','XX','XX','XX'], drums: ['HIT','XX','XX','XX','HIT','XX','XX','XX','HIT','XX','XX','XX','HIT','XX','XX','XX'] }, 
    danger: { tempo: 330, lead: ['E5','XX','A5','XX','G5','XX','B5','XX','A5','XX','G5','XX','F5','XX','D#5','XX','G5','XX','Bb5','XX','C6','XX','Bb5','XX','A5','XX','XX','XX','XX','XX','XX','XX'], bass: ['C3','XX','E3','XX','G#3','XX','A3','XX','F3','XX','A3','XX','F#3','XX','E3','XX','G3','XX','Bb2','XX','B2','XX','C3','XX','G3','XX','XX','XX','XX','XX','XX','XX'], drums: ['HIT','HIT','HIT','XX','HIT','XX','HIT','HIT'] }, 
    marching: { tempo: 376, lead: ['G5','XX','Bb5','XX','C6','XX','Bb5','XX','A5','XX','G5','XX','F#5','XX','E5','XX','A5','XX','C6','XX','D6','XX','C6','XX','Bb5','XX','XX','XX','XX','XX','XX','XX'], bass: ['C3','XX','G3','XX','Ab3','XX','B3','XX','F3','XX','C4','XX','B3','XX','Bb3','XX','A3','XX','C4','XX','Eb4','XX','E4','XX','G3','XX','XX','XX','XX','XX','XX','XX'], drums: ['HIT','XX','HIT','XX','HIT','XX','HIT','XX'] }, 
    venom_p1: { tempo: 320, lead: ['A4','C5','E5','A5','Bb5','A5','G5','F5','E5','D5','C#5','D5','E5','XX','A4','XX'], bass: ['A2','XX','E3','XX','G3','XX','A3','XX','A3','XX','C4','XX','B3','XX','A3','XX'], drums: ['K','XX','XX','XX','S','XX','XX','XX'] }, 
    venom_p2: { tempo: 360, lead: ['A4','C5','E5','A5','Bb5','A5','G5','F5','E5','D5','C#5','D5','E5','XX','A4','XX'], bass: ['A2','A2','E3','E3','G3','G3','A3','A3','A3','A3','C4','C4','B3','B3','A3','A3'], drums: ['K_t','XX','XX','XX','K_t','XX','XX','XX'] }, 
    venom_full: { tempo: 400, lead: ['A4','C5','E5','A5','Bb5','A5','G5','F5','E5','D5','C#5','D5','E5','XX','A4','XX'], bass: ['A2','A2','A2','A2','Bb2','Bb2','Bb2','Bb2','A2','A2','A2','A2','G#2','G#2','G#2','G#2'], drums: ['K_H','S_h','K_H','S_h','K_H','S_h','K_H','S_h'] }, 
    chaos_p1: { tempo: 300, lead: ['D5','F5','A5','D6','A5','F5','D5','A4','F5','XX','E5','XX','D5','C#5','D5','E5'], bass: ['D3','XX','D3','XX','D3','XX','D3','XX','A2','XX','A2','XX','A2','XX','A2','XX'], drums: ['K','XX','h','XX','S','XX','h','XX'] }, 
    chaos_p2: { tempo: 330, lead: ['D5','XX','XX','F5','XX','A5','XX','D6','C#6','XX','A5','XX','E5','XX','A4','XX'], bass: ['D3','XX','D3','XX','F3','XX','D3','XX','A2','XX','A2','XX','C#3','XX','A2','XX'], drums: ['K','XX','K','XX','S','XX','h','XX'] }, 
    chaos_full: { tempo: 360, lead: ['D6','C#6','C6','B5','Bb5','A5','Ab5','G5','F#5','F5','E5','Eb5','D5','C#5','C5','B4'], bass: ['D3','D3','D3','D3','C#3','C#3','C#3','C#3','C3','C3','C3','C3','B2','B2','B2','B2'], drums: ['K','h','S','h','K','h','S','h'] }, 
    hero_extended: { tempo: 350, lead: ['A4','C5','E5','A5','E5','C5','A4','XX','F4','A4','C5','F5','C5','A4','F4','XX'], bass: ['A2','A2','A2','A2','A2','A2','A2','A2','F2','F2','F2','F2','F2','F2','F2','F2'], drums: ['K','h','S','h','K','h','S','h'] } 
}; 

// ========================================== 
// 2. STATE & VARIABLES 
// ========================================== 
let musicCtx, currentSong, nextNoteTime = 0, noteIndex = 0, musicTimerId; 
let musicOn = true, sfxOn = true; 
let db; 
let lastSFX = 0; 
let lastReinforce = 0;

const gameState = { 
    isRunning: false, isPaused: false, isGameOver: false, 
    score: 0, levelIdx: 0, startTime: 0, lives: 2, 
    level10Pending: false, blackBoxSpawned: false 
}; 

const input = { up: false, down: false, left: false, right: false, dash: false }; 
const player = { x: 0, y: 0, speed: 3, baseSpeed: 3, dashSpeed: 9, size: 16, dashTimer: 0, dashCooldown: 0, invulnerable: false, invulnerableTimer: 0 }; 
let enemies = [], coins = [], particles = [], healthBag = null, blackBox = null; 

// ========================================== 
// 3. FIREBASE LOGIC 
// ========================================== 
try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); }  
catch (e) { console.error("Firebase Error", e); } 

const lbScreen = document.getElementById('leaderboard-screen'); 
const scoresList = document.getElementById('scores-list'); 

async function loadLeaderboard() { 
    scoresList.innerHTML = '<div style="color: #888;">LOADING...</div>'; 
    if(!db) { scoresList.innerHTML = '<div style="color: #b45252;">DB ERROR</div>'; return; } 
    try { 
        const q = db.collection("scores").orderBy("score", "desc").limit(10); 
        const snapshot = await q.get(); 
        scoresList.innerHTML = ''; 
        let rank = 1; 
        snapshot.forEach((doc) => { 
            const d = doc.data(); 
            scoresList.innerHTML += `<div class="lb-row"><span style="color:#d3a068">#${rank++}</span><span>${d.name}</span><span style="color:#00ff00">${d.score}</span></div>`; 
        }); 
        if (snapshot.empty) scoresList.innerHTML = '<div style="color:#555">NO SCORES</div>'; 
    } catch (error) { console.error(error); scoresList.innerHTML = '<div style="color:#b45252">ERROR</div>'; } 
} 

async function saveScore() { 
    const name = (document.getElementById('player-name-input').value || "ANON").toUpperCase(); 
    const btn = document.getElementById('submit-score-btn'); 
    if(!db) { alert("DB Error"); return; } 
    btn.textContent = "..."; 
    try { 
        await db.collection("scores").add({ name: name, score: gameState.score, date: firebase.firestore.FieldValue.serverTimestamp() }); 
        document.getElementById('start-screen').style.display = 'none'; 
        lbScreen.style.display = 'flex'; 
        loadLeaderboard(); 
        btn.textContent = "SUBMIT"; 
    } catch (e) { console.error(e); btn.textContent = "ERROR"; } 
} 

// ========================================== 
// 4. AUDIO ENGINE 
// ========================================== 
const NOTES = { 'E2':82.41,'F2':87.31,'F#2':92.5,'G2':98,'G#2':103.8,'A2':110,'Bb2':116.5,'B2':123.5,'C3':130.8,'C#3':138.6,'D3':146.8,'Eb3':155.6,'E3':164.8,'F3':174.6,'F#3':185,'G3':196,'G#3':207.7,'A3':220,'Bb3':233.1,'B3':246.9,'C4':261.6,'C#4':277.2,'D4':293.7,'D#4':311.1,'E4':329.6,'F4':349.2,'F#4':370,'G4':392,'G#4':415.3,'A4':440,'Bb4':466.2,'B4':493.9,'C5':523.3,'C#5':554.4,'D5':587.3,'Eb5':622.3,'E5':659.3,'F5':698.5,'F#5':740,'G5':784,'G#5':830.6,'A5':880,'Bb5':932.3,'B5':987.8,'C6':1047,'C#6':1109,'D6':1175,'E6':1319,'F6':1397,'G6':1568,'A6':1760,'XX':0 }; 

function initAudio() { if (!musicCtx) musicCtx = new (window.AudioContext || window.webkitAudioContext)(); if(musicCtx.state==='suspended')musicCtx.resume(); } 

function playMusic(name) { 
    if (!musicOn) { currentSong = name; return; } 
    initAudio(); 
    if (currentSong === name && musicTimerId) return; 
    stopMusic(); 
    const song = SONGS[name]; 
    if (!song) return; 
    currentSong = name; noteIndex = 0; nextNoteTime = musicCtx.currentTime; 
    scheduleMusic(song); 
} 

function stopMusic() { clearTimeout(musicTimerId); musicTimerId = null; } 

function scheduleMusic(song) { 
    const secPerBeat = 60.0 / song.tempo; 
    while (nextNoteTime < musicCtx.currentTime + 0.1) { 
        let lead = song.lead[noteIndex % song.lead.length]; 
        let bass = song.bass[noteIndex % song.bass.length]; 
        playTone(lead, nextNoteTime, 'square', 0.1); 
        playTone(bass, nextNoteTime, 'triangle', 0.15); 
        if(song.drums) parseDrum(song.drums[noteIndex % song.drums.length], nextNoteTime); 
        nextNoteTime += secPerBeat; 
        noteIndex++; 
    } 
    musicTimerId = setTimeout(() => scheduleMusic(song), 25); 
} 

function playTone(note, time, type, vol) { 
    if (note === 'XX' || !NOTES[note]) return; 
    const osc = musicCtx.createOscillator(); const g = musicCtx.createGain(); 
    osc.type = type; osc.frequency.value = NOTES[note]; 
    g.gain.setValueAtTime(vol, time); g.gain.exponentialRampToValueAtTime(0.01, time + 0.1); 
    osc.connect(g); g.connect(musicCtx.destination); osc.start(time); osc.stop(time + 0.15); 
} 

function parseDrum(code, time) { 
    if(!code || code==='XX') return; 
    if(code === 'HIT') playSFX('hit', time); 
    if(code.includes('K')) playSFX('kick', time); 
    if(code.includes('S')) playSFX('snare', time); 
    if(code.includes('h')) playSFX('hat', time); 
} 

function playSFX(type, time = 0) { 
    if(!musicCtx || !sfxOn) return; 
    
    // THROTTLE EXPLOSION SOUNDS (Performance)
    if(type === 'kick' || type === 'hit') {
        const now = Date.now();
        if(now - lastSFX < 100) return; 
        lastSFX = now;
    }

    const t = time || musicCtx.currentTime; 
    const osc = musicCtx.createOscillator(); const g = musicCtx.createGain(); 
    osc.connect(g); g.connect(musicCtx.destination); 
    
    if (type === 'coin') { 
        osc.type = 'square'; osc.frequency.setValueAtTime(600, t); osc.frequency.exponentialRampToValueAtTime(1200, t+0.1);  
        g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1); osc.start(t); osc.stop(t+0.1); 
    } else if (type === 'dash') { 
        osc.type = 'triangle'; osc.frequency.setValueAtTime(300, t); osc.frequency.linearRampToValueAtTime(100, t+0.15);  
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.15); osc.start(t); osc.stop(t+0.15); 
    } else if (type === 'hit') { 
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(50, t+0.3);  
        g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.3); osc.start(t); osc.stop(t+0.3); 
    } else if (type === 'kick') { 
        osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.01, t+0.5); 
        g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.5); osc.start(t); osc.stop(t+0.5); 
    } else if (type === 'snare') { 
        osc.type='square'; osc.frequency.setValueAtTime(200, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1); osc.start(t); osc.stop(t+0.1); 
    } else if (type === 'hat') { 
        osc.type='square'; osc.frequency.setValueAtTime(1000, t); g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.05); osc.start(t); osc.stop(t+0.05); 
    } else if (type === 'level') { 
        osc.type = 'triangle'; osc.frequency.setValueAtTime(400, t); osc.frequency.setValueAtTime(600, t+0.1);  
        g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.5); osc.start(t); osc.stop(t+0.5); 
    } else if (type === 'secret') { 
        osc.type = 'sine'; osc.frequency.setValueAtTime(1000, t); osc.frequency.linearRampToValueAtTime(2000, t+1);  
        g.gain.setValueAtTime(0.2, t); osc.start(t); osc.stop(t+1); 
    } 
} 

// ========================================== 
// 5. GAME LOGIC 
// ========================================== 
const ctx = document.getElementById('gameCanvas').getContext('2d'); 
const ui = { 
    score: document.getElementById('score-display'), 
    lives: document.getElementById('lives-display'), 
    level: document.getElementById('level-display'), 
    timer: document.getElementById('timer-display'), 
    msg: document.getElementById('msg-overlay'), 
    dash: document.getElementById('dash-bar'), 
    led: document.getElementById('power-led') 
}; 

function initGame() { 
    initAudio(); 
    
    // UNHIDE UI
    document.getElementById('hud').style.display = 'flex';
    document.getElementById('dash-bar-container').style.display = 'block';

    // Remove preload class to allow animations
    document.body.classList.remove('preload');

    ui.led.classList.add('on'); 
    gameState.score = 0; 
    gameState.levelIdx = 0; 
    gameState.lives = 2; 
    updateLives(); 
    gameState.isRunning = true; 
    gameState.isGameOver = false; 
    gameState.isPaused = false; 
    player.x = CANVAS_SIZE/2; player.y = CANVAS_SIZE/2; 
    
    // UI Reset 
    document.querySelectorAll('.modal-screen').forEach(s => s.style.display = 'none'); 
    document.getElementById('game-title').style.display = 'none'; 
    document.getElementById('settings-btn').style.display = 'flex'; 
    document.getElementById('start-screen').classList.remove('game-over-mode'); 
    
    startLevel(0); 
    requestAnimationFrame(gameLoop); 
} 

function startLevel(idx) { 
    if (idx === 9 && !gameState.level10Pending) { 
        gameState.isPaused = true; 
        playMusic('victory'); 
        document.getElementById('level10-screen').style.display = 'flex'; return; 
    } 
    gameState.levelIdx = idx; 
    const cfg = LEVELS[idx]; 
    if (cfg.music) playMusic(cfg.music); 
    
    enemies = []; coins = []; particles = []; healthBag = null; gameState.blackBoxSpawned = false; blackBox = null; 
    if (gameState.lives < 2) { gameState.lives = 2; updateLives(); playSFX('heal'); } 

    // Spawn Logic 
    if(cfg.type === 'snake') { 
        let sx=20, sy=20; 
        for(let i=0; i<cfg.snakeLen; i++) { 
            enemies.push({ x: sx, y: sy, size: 16, type: 'snake', speed: 0.5 + (cfg.speedLevel*0.35) + 0.5, index: i }); 
        } 
    } else if (cfg.type === 'petri') {
        // LEVEL 10 START: Spawn a few Medium cells 
        for(let i=0; i<4; i++) spawnEnemy('petri_medium');
    } else { 
        spawnEnemy(cfg.type); 
    } 
    spawnCoin(); spawnCoin(); if (Math.random() < 0.3) spawnHealthBag(); 
    
    gameState.startTime = Date.now(); 
    ui.level.textContent = `LVL: ${cfg.id}`; 
    ui.msg.textContent = cfg.msg; ui.msg.style.display = 'block'; 
    setTimeout(() => ui.msg.style.display = 'none', 1000); 
    playSFX('level'); 
} 

function update() { 
    const cfg = LEVELS[gameState.levelIdx]; 
    const elapsed = (Date.now() - gameState.startTime) / 1000; 
    
    // Level Progression 
    let complete = gameState.score >= cfg.targetScore && cfg.id !== 10; 
    if (cfg.timeLimit) { 
        const rem = Math.ceil(cfg.timeLimit - elapsed); 
        ui.timer.textContent = `TIME: ${rem}`; 
        if (rem <= 0) complete = true; 
    } else ui.timer.textContent = ""; 

    if (complete && gameState.levelIdx < LEVELS.length - 1) { startLevel(gameState.levelIdx + 1); return; } 

    // Secrets 
    if (cfg.id === 10 && gameState.score >= 3000 && enemies.length >= 30 && !gameState.blackBoxSpawned) { 
        gameState.blackBoxSpawned = true; 
        blackBox = { x: Math.random()*(CANVAS_SIZE-30), y: Math.random()*(CANVAS_SIZE-30), size: 16 }; 
        playSFX('secret'); 
    } 
    if (blackBox && checkCollision(player, blackBox)) { gameOver("YOU ESCAPED<br>THE SYSTEM!"); return; } 

    // Standard Spawning (L1-L9)
    if (['chaser','bouncer','endless'].includes(cfg.type)) { 
        if (Date.now() % (cfg.spawnRate*10) < 20 && enemies.length < (cfg.maxEnemies||999)) { 
            for(let i=0; i<(cfg.spawnCount||1); i++) spawnEnemy(cfg.type==='endless'?'bouncer':cfg.type); 
        } 
    } 
    
    // LEVEL 10 PETRI LOGIC
    if(cfg.type === 'petri') {
        if(enemies.length < 10 && Date.now() - lastReinforce > 2000) {
             lastReinforce = Date.now();
             spawnEnemy('petri_medium'); spawnEnemy('petri_medium'); spawnEnemy('petri_medium');
        }
        
        // FISSION
        if (Date.now() % 4000 < 20 && enemies.length < cfg.maxEnemies) { 
            const splitCandidates = enemies.filter(e => e.gen === 1 && e.age > 80);
            if(splitCandidates.length > 0) {
                const parent = splitCandidates[Math.floor(Math.random()*splitCandidates.length)];
                enemies = enemies.filter(e => e !== parent);
                spawnEnemy('petri_small', parent.x, parent.y);
                spawnEnemy('petri_small', parent.x, parent.y);
                playSFX('hit'); 
            }
        }
    }

    // Player Physics 
    if (player.invulnerable) { player.invulnerableTimer--; if(player.invulnerableTimer<=0) player.invulnerable=false; } 
    
    if (input.dash && player.dashCooldown <= 0) { player.dashTimer = DASH_DURATION; player.dashCooldown = DASH_COOLDOWN; playSFX('dash'); } 
    if (player.dashTimer > 0) { 
        player.speed = player.dashSpeed; player.dashTimer--; 
        if(Math.random()>0.5) particles.push({x: player.x, y: player.y, vx: 0, vy: 0, life: 10, color: PALETTE.dashTrail, isGhost: true}); 
    } else player.speed = player.baseSpeed; 
    if (player.dashCooldown > 0) player.dashCooldown--; 
    
    ui.dash.style.transform = `scaleX(${Math.max(0, (DASH_COOLDOWN - player.dashCooldown) / DASH_COOLDOWN)})`; 
    ui.dash.style.backgroundColor = player.dashCooldown > 0 ? '#b45252' : '#00ff00'; 

    if (input.up && player.y > 0) player.y -= player.speed; 
    if (input.down && player.y < CANVAS_SIZE - player.size) player.y += player.speed; 
    if (input.left && player.x > 0) player.x -= player.speed; 
    if (input.right && player.x < CANVAS_SIZE - player.size) player.x += player.speed; 

    // Entity Loop
    for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        if(!e) continue;
        
        if (e.age !== undefined) e.age++;

        // MOVEMENT
        if (e.type === 'chaser') { 
            if (e.x < player.x) e.x += e.speed; else e.x -= e.speed; 
            if (e.y < player.y) e.y += e.speed; else e.y -= e.speed; 
        } else if (e.type === 'snake') { 
            let tx, ty; 
            if(e.index === 0) { tx=player.x; ty=player.y; } 
            else { tx=enemies[e.index-1].x; ty=enemies[e.index-1].y; } 
            let dx=tx-e.x, dy=ty-e.y, dist=Math.sqrt(dx*dx+dy*dy); 
            if(dist > (e.index===0?0:12)) { e.x += (dx/dist)*e.speed; e.y += (dy/dist)*e.speed; } 
        } else if (e.type === 'bouncer' || e.type.startsWith('petri')) { 
            e.x += e.vx; e.y += e.vy; 
            
            const isRefract = (gameState.levelIdx === 8 || gameState.levelIdx === 9); 
            let hitWall = false;

            // X Wall Check (With Anti-Stick Clamp)
            if(e.x <= 0) {
                e.x = 0; e.vx = Math.abs(e.vx); hitWall = true;
                if(isRefract) { e.vy = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * e.speed); }
            }
            else if(e.x >= CANVAS_SIZE - e.size) {
                e.x = CANVAS_SIZE - e.size; e.vx = -Math.abs(e.vx); hitWall = true;
                if(isRefract) { e.vy = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * e.speed); }
            }

            // Y Wall Check (With Anti-Stick Clamp)
            if(e.y <= 0) {
                e.y = 0; e.vy = Math.abs(e.vy); hitWall = true;
                if(isRefract) { e.vx = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * e.speed); }
            }
            else if(e.y >= CANVAS_SIZE - e.size) {
                e.y = CANVAS_SIZE - e.size; e.vy = -Math.abs(e.vy); hitWall = true;
                if(isRefract) { e.vx = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * e.speed); }
            }
            
            // Giant Rupture
            if(hitWall && e.gen === 0 && e.age > 30) { 
                enemies.splice(i, 1); 
                spawnEnemy('petri_small', e.x, e.y);
                spawnEnemy('petri_small', e.x, e.y);
                playSFX('kick');
                continue;
            }
            
            if(hitWall && e.bounceCount !== undefined) e.bounceCount++;
        }
        
        // FUSION
        if(cfg.id === 10 && e.gen === 2 && e.age > 60) { 
            for(let j = i - 1; j >= 0; j--) { 
                let other = enemies[j];
                if(other.gen === 2 && other.age > 60 && checkCollision(e, other)) {
                    if(e.bounceCount >= 3 && other.bounceCount >= 3) {
                        const mx = (e.x + other.x)/2;
                        const my = (e.y + other.y)/2;
                        enemies.splice(i, 1); 
                        enemies.splice(j, 1); 
                        spawnEnemy('petri_giant', mx, my);
                        playSFX('kick');
                        break; 
                    }
                }
            }
        }
        
        // PLAYER DAMAGE
        if (checkCollision(player, e) && !player.invulnerable) { 
            gameState.lives--; updateLives(); playSFX('hit'); 
            if(gameState.lives <= 0) gameOver("CAUGHT!"); 
            else { player.invulnerable = true; player.invulnerableTimer = INVULNERABLE_DURATION; } 
        } 
    }; 

    for(let i=coins.length-1; i>=0; i--) { 
        if(checkCollision(player, coins[i])) {  
            playSFX('coin'); gameState.score+=10; ui.score.textContent = `SCORE: ${gameState.score}`;  
            coins.splice(i, 1); spawnCoin();  
        } 
    } 
    if(healthBag && checkCollision(player, healthBag)) { gameState.lives=2; updateLives(); playSFX('heal'); healthBag=null; } 
    
    for(let i=particles.length-1; i>=0; i--) {  
        let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life--;  
        if(p.life<=0) particles.splice(i,1);  
    } 
} 

function draw() { 
    const cfg = LEVELS[gameState.levelIdx]; 
    for(let y=0; y<CANVAS_SIZE; y+=32) { for(let x=0; x<CANVAS_SIZE; x+=32) {  
        ctx.fillStyle = ((x+y)/32)%2===0 ? cfg.bg[0] : cfg.bg[1]; ctx.fillRect(x,y,32,32);  
    }} 
    
    particles.forEach(p => { ctx.fillStyle=p.color; if(p.isGhost) drawSprite(SPRITES.hero,p.x,p.y,p.color); else ctx.fillRect(p.x,p.y,3,3); }); 
    coins.forEach(c => drawSprite(SPRITES.coin, c.x, c.y, PALETTE.coinMain, PALETTE.coinShine)); 
    if(healthBag) drawSprite(SPRITES.healthBag, healthBag.x, healthBag.y, PALETTE.health, PALETTE.healthCross); 
    if(blackBox) drawSprite(SPRITES.blackBox, blackBox.x, blackBox.y, PALETTE.blackBox, '#333'); 
    
    enemies.forEach(e => { 
        let sprite = SPRITES.slime; let col = PALETTE.slime; 
        if(e.type==='snake') { sprite=(e.index===0?SPRITES.snakeHead:null); col=PALETTE.snake; } 
        if(e.type==='bouncer') { sprite=SPRITES.slime; col=PALETTE.bouncer; } 
        
        if(e.type.startsWith('petri')) {
            if(e.gen === 0) { col = PALETTE.cellGiant; } 
            if(e.gen === 1) { col = PALETTE.bouncer; }   
            if(e.gen === 2) { col = PALETTE.cellSmall; } 
            
            if(e.gen === 0) { ctx.fillStyle=col; ctx.fillRect(e.x,e.y,e.size,e.size); return; }
            sprite = SPRITES.slime;
        }

        if(sprite) drawSprite(sprite, e.x, e.y, col); 
        else { ctx.fillStyle=col; ctx.fillRect(e.x+2,e.y+2,12,12); } 
    }); 

    if(!player.invulnerable || Math.floor(Date.now()/100)%2===0) drawSprite(SPRITES.hero, player.x, player.y, PALETTE.hero); 
} 

function drawSprite(map, x, y, c1, c2) { 
    const s = 2; map.forEach((row,r) => row.forEach((px,c) => { 
        if(px===1){ctx.fillStyle=c1; ctx.fillRect(x+c*s,y+r*s,s,s);} 
        if(px===2 && c2){ctx.fillStyle=c2; ctx.fillRect(x+c*s,y+r*s,s,s);} 
    })); 
} 
function spawnEnemy(type, x=null, y=null) { 
    const cfg = LEVELS[gameState.levelIdx]; 
    let ex = x !== null ? x : Math.random()*(CANVAS_SIZE-20);
    let ey = y !== null ? y : Math.random()*(CANVAS_SIZE-20);
    if(x===null && Math.abs(ex-player.x)<50) ex+=100; 
    
    let e = { x: ex, y: ey, size: 12, type: type, age: 0 }; 
    let spd = 0.5 + (cfg.speedLevel*0.35) + (Math.random()*0.2); 
    
    if(type === 'bouncer') {
        if(cfg.id === 7) spd = 2.5; 
        if(cfg.id === 8) spd = 2.65; 
        if(cfg.id === 9) spd = 2.8; 
        e.vx = (Math.random()>.5?1:-1)*spd; 
        e.vy = (Math.random()>.5?1:-1)*spd; 
    }
    
    if(type.startsWith('petri')) {
        e.bounceCount = 0;
        if(type === 'petri_giant') { e.size = 24; e.gen = 0; spd = 1.5; } 
        else if(type === 'petri_medium') { e.size = 16; e.gen = 1; spd = 2.5; } 
        else if(type === 'petri_small') { e.size = 12; e.gen = 2; spd = 3.2; }
        e.vx = (Math.random()>.5?1:-1)*spd; e.vy = (Math.random()>.5?1:-1)*spd;
    }
    
    e.speed = spd; enemies.push(e); 
} 
function spawnCoin() { coins.push({ x: 20+Math.random()*(CANVAS_SIZE-40), y: 20+Math.random()*(CANVAS_SIZE-40), size: 16 }); } 
function spawnHealthBag() { healthBag = { x: 20+Math.random()*(CANVAS_SIZE-40), y: 20+Math.random()*(CANVAS_SIZE-40), size: 16 }; } 
function checkCollision(r1, r2) { const m=4; return r1.x+m < r2.x+r2.size-m && r1.x+r1.size-m > r2.x+m && r1.y+m < r2.y+r2.size-m && r1.y+r1.size-m > r2.y+m; } 
function updateLives() { ui.lives.textContent = "♥".repeat(gameState.lives); } 

function resetToTitle() { 
    gameState.isGameOver = true; gameState.isRunning = false; stopMusic();  
    ui.led.classList.remove('on'); 
    
    // Hide UI overlays to prevent glitch
    document.getElementById('hud').style.display = 'none';
    document.getElementById('dash-bar-container').style.display = 'none';

    document.querySelectorAll('.modal-screen').forEach(s => s.style.display = 'none'); 
    document.getElementById('game-title').innerHTML = "POCKET<br>ABYSS"; 
    document.getElementById('game-title').style.display = 'block'; 
    document.getElementById('end-game-info').style.display = 'none'; 
    document.getElementById('name-input-container').style.display = 'none'; 
    document.getElementById('home-btn').style.display = 'none'; 
    document.getElementById('settings-btn').style.display = 'flex'; 
    document.getElementById('start-screen').classList.remove('game-over-mode'); 
    document.getElementById('start-btn').textContent = "START GAME"; 
    document.getElementById('start-screen').style.display = 'flex'; 
    
    gameState.lives = 2; 
    updateLives(); 
    playMusic('intro'); 
} 

function gameOver(reason) { 
    gameState.isGameOver = true; gameState.isRunning = false; stopMusic(); ui.led.classList.remove('on'); 
    document.getElementById('game-title').innerHTML = (reason.includes('ESCAPED')||reason.includes('Thanks')) ? "YOU<br>WIN!" : "GAME<br>OVER"; 
    document.getElementById('game-title').style.display = 'block'; 
    document.getElementById('settings-btn').style.display = 'none'; 
    const info = document.getElementById('end-game-info'); 
    info.style.display = 'block'; 
    document.getElementById('level-msg').innerHTML = reason === "CAUGHT!" ? ["TOO SLOW!", "TRY AGAIN", "OUCH!"][Math.floor(Math.random()*3)] : reason; 
    document.getElementById('final-score').textContent = `SCORE: ${gameState.score}`; 
    document.getElementById('final-score').classList.add('score-pop'); 
    
    document.getElementById('start-screen').classList.add('game-over-mode');
    document.getElementById('start-btn').textContent = "RETRY"; 
    
    if(gameState.score > 0) { 
        document.getElementById('name-input-container').style.display = 'flex'; 
        document.getElementById('player-name-input').value = ""; 
    } else { 
        document.getElementById('name-input-container').style.display = 'none'; 
    } 
    document.getElementById('home-btn').style.display = 'block'; 
    document.getElementById('start-screen').style.display = 'flex'; 

    playMusic(reason.includes('WIN') ? 'victory' : 'gameover'); 
} 

function gameLoop() { 
    if(!gameState.isRunning || gameState.isPaused) return; 
    update(); draw(); requestAnimationFrame(gameLoop); 
} 

function togglePause() { 
    if(!gameState.isRunning || gameState.isGameOver) return; 
    gameState.isPaused = !gameState.isPaused; 
    if(gameState.isPaused) { 
        document.getElementById('pause-level-txt').textContent = "LEVEL " + LEVELS[gameState.levelIdx].id; 
        document.getElementById('pause-menu').style.display = 'flex'; 
        document.getElementById('settings-btn').style.display = 'none'; 
        stopMusic(); 
    } else { 
        startCountdown(); 
    } 
} 

function startCountdown() { 
    document.getElementById('pause-menu').style.display = 'none'; 
    const overlay = document.getElementById('countdown-overlay'); 
    overlay.style.display = 'flex'; 
    let count = 5; 
    function showNum(n) { overlay.innerHTML = `<div class="countdown-num">${n}</div>`; } 
    showNum(count); 
    const timer = setInterval(() => { 
        count--; 
        if(count > 0) showNum(count); 
        else { 
            clearInterval(timer); 
            overlay.style.display = 'none'; 
            document.getElementById('settings-btn').style.display = 'flex'; 
            gameState.isPaused = false; 
            if(musicOn && currentSong) playMusic(currentSong); 
            gameLoop(); 
        } 
    }, 1000); 
} 

function setInput(k, v) {  
    input[k] = v;  
    const el = document.getElementById(k==='dash'?'btn-a':`btn-${k}`); 
    if(el) { v ? el.classList.add('active') : el.classList.remove('active'); } 
} 

window.addEventListener('keydown', e => { 
    if(e.code==='KeyP') togglePause(); 
    
    if(gameState.isPaused) return; 
    if(e.code==='ArrowUp') setInput('up', true); 
    if(e.code==='ArrowDown') setInput('down', true); 
    if(e.code==='ArrowLeft') setInput('left', true); 
    if(e.code==='ArrowRight') setInput('right', true); 
    if(e.code==='KeyZ'||e.code==='Space') setInput('dash', true); 
}); 
window.addEventListener('keyup', e => { 
    if(e.code==='ArrowUp') setInput('up', false); 
    if(e.code==='ArrowDown') setInput('down', false); 
    if(e.code==='ArrowLeft') setInput('left', false); 
    if(e.code==='ArrowRight') setInput('right', false); 
    if(e.code==='KeyZ'||e.code==='Space') setInput('dash', false); 
}); 

const dPad = document.querySelector('.d-pad'); 
function handleTouch(e) { 
    e.preventDefault(); 
    if(gameState.isGameOver || gameState.isPaused) return; 
    const rect = dPad.getBoundingClientRect(); 
    const touch = e.touches[0]; 
    const x = (touch.clientX - rect.left) / rect.width; 
    const y = (touch.clientY - rect.top) / rect.height; 
    setInput('up', y < 0.4); setInput('down', y > 0.6); 
    setInput('left', x < 0.4); setInput('right', x > 0.6); 
} 
dPad.addEventListener('touchstart', handleTouch, {passive:false}); 
dPad.addEventListener('touchmove', handleTouch, {passive:false}); 
dPad.addEventListener('touchend', (e) => { e.preventDefault(); ['up','down','left','right'].forEach(k=>setInput(k,false)); }); 

document.getElementById('btn-a').addEventListener('touchstart', (e)=>{ e.preventDefault(); setInput('dash',true); setTimeout(()=>setInput('dash',false),200); }); 
document.getElementById('btn-b').addEventListener('touchstart', (e)=>{ e.preventDefault(); togglePause(); }); 

document.getElementById('start-btn').addEventListener('click', initGame); 
document.getElementById('settings-btn').addEventListener('click', togglePause); 
document.getElementById('resume-btn').addEventListener('click', () => { if(gameState.isPaused) togglePause(); }); 
document.getElementById('home-btn').addEventListener('click', resetToTitle); 
document.getElementById('pause-home-btn').addEventListener('click', () => { gameState.isPaused = false; resetToTitle(); }); 

document.getElementById('pause-help-btn').addEventListener('click', () => { document.getElementById('pause-menu').style.display='none'; document.getElementById('help-screen').style.display='flex'; }); 
document.getElementById('start-help-btn').addEventListener('click', () => { document.getElementById('start-screen').style.display='none'; document.getElementById('help-screen').style.display='flex'; document.getElementById('settings-btn').style.display='none'; }); 
document.getElementById('close-help-btn').addEventListener('click', () => {  
    document.getElementById('help-screen').style.display='none'; 
    if(gameState.isRunning && gameState.isPaused) document.getElementById('pause-menu').style.display='flex'; 
    else {  
        document.getElementById('start-screen').style.display='flex';  
        document.getElementById('settings-btn').style.display='flex'; 
    } 
}); 

function updateAudioUI() { 
    document.querySelectorAll('.toggle-music').forEach(b => { 
        b.textContent = musicOn ? "ON" : "OFF"; 
        musicOn ? b.classList.add('active') : b.classList.remove('active'); 
    }); 
    document.querySelectorAll('.toggle-sfx').forEach(b => { 
        b.textContent = sfxOn ? "ON" : "OFF"; 
        sfxOn ? b.classList.add('active') : b.classList.remove('active'); 
    }); 
} 

document.querySelectorAll('.toggle-music').forEach(btn => { 
    btn.addEventListener('click', () => { 
        musicOn = !musicOn; 
        updateAudioUI(); 
        if(musicOn && currentSong) playMusic(currentSong); else stopMusic(); 
    }); 
}); 

document.querySelectorAll('.toggle-sfx').forEach(btn => { 
    btn.addEventListener('click', () => { 
        sfxOn = !sfxOn; 
        updateAudioUI(); 
    }); 
}); 

document.getElementById('l10-yes-btn').addEventListener('click', () => { gameState.level10Pending=true; document.getElementById('level10-screen').style.display='none'; gameState.isPaused=false; startLevel(9); gameLoop(); }); 
document.getElementById('l10-no-btn').addEventListener('click', () => { document.getElementById('level10-screen').style.display='none'; gameOver("Thanks for playing !!"); }); 
document.getElementById('view-lb-btn').addEventListener('click', () => { document.getElementById('start-screen').style.display='none'; document.getElementById('leaderboard-screen').style.display='flex'; loadLeaderboard(); document.getElementById('settings-btn').style.display='none'; }); 
document.getElementById('close-lb-btn').addEventListener('click', () => { document.getElementById('leaderboard-screen').style.display='none'; document.getElementById('start-screen').style.display='flex'; document.getElementById('settings-btn').style.display='flex'; }); 
document.getElementById('submit-score-btn').addEventListener('click', saveScore); 

// Init 
document.getElementById('start-screen').style.display = 'flex'; 
playMusic('intro'); 
</script> 
</body> 
</html>
